= Runtime Fabric でのアプリケーションのバージョン管理
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

アプリケーションが Runtime Fabric にデプロイされると、Runtime Manager は自動的にアプリケーションとその設定をバージョン管理します。アプリケーションのバージョン管理により、次のことができます。

* アプリケーションの設定変更履歴を表示する。
* 現在適用されている設定に問題がある場合や不安定な場合に、設定を以前のバージョンにロールバックする。
* アプリケーションの状況を表示する。可能な値:
** Running (実行中): 少なくとも 1 つのレプリカがトラフィックを受信中 (開始状態) です。
** Not running (停止中): どのレプリカもトラフィックを受信していません。
** Unknown (不明): 対象が切断されています。
* 次のようなデプロイされたアプリケーションの設定を更新する。
** アプリケーションのパッケージ。
** アプリケーションデプロイメントのパッケージバージョン。
** ランタイムバージョン、レプリカ数、アプリケーションがクラスタモードで実行されているかどうかなどのデプロイメント対象設定。
** リソース割り当て (コア数とメモリ割り当てを含む)
** イングレスおよびプロパティ値。


== アプリケーションの設定ページにアクセスする

. Anypoint Platform にサインインし、*[Runtime Manager]* に移動します。
+
*[Applications (アプリケーション)]* ページが表示されます。

. *[Applications (アプリケーション)]* ページから、Runtime Fabric にデプロイするアプリケーションを選択します。
. 右側で管理パネルを開きます。
. 管理パネルで、*[Manage Application (アプリケーションを管理)]* ボタンをクリックします。
+
*[Settings {設定)]* ページに、アプリケーションの状況に関する情報、設定履歴、およびアプリケーションに関するその他の役立つ情報が表示されます。
+
アプリケーションの *[Settings (設定)]* ページの *[Config changes (設定の変更)]* タブで、Runtime Fabric の正常にデプロイされたアプリケーション設定に対する各変更が表示されます。
+
最後の 10 個の設定デプロイメントがそれぞれの設定日順に表示されます。履歴内の各設定には、それを識別する一意のハッシュがあります。

image::app-versioning.png[]

[NOTE]
設定履歴には、作成日順に最新の 10 件の設定デプロイメントが表示されます。

*[All changes (すべての変更)]* タブには、設定デプロイメントから作成されたバージョンの履歴、および各バージョンで実行されたアクションが表示されます。


== 設定の変更を適用する

. アプリケーションの *[Settings (設定)]* ページで、デプロイされた設定に次の変更を加えることができます。 +
* 新しいアプリケーションパッケージをアップロードする。
* デプロイメント対象とリソース割り当てを変更する。
* *[Ingress (イングレス)]* および *[Properties (プロパティ)]* の値を変更する。
. 変更したら、*[Apply Changes (変更を適用)]* をクリックします。 +
*[Settings (設定)]* ページの上部に、ステータスバーが表示されます。
+
image:app-versioning-applying-config.png[]
. *[View Status (状況を表示)]* をクリックし、デプロイメントの各レプリカの状況を表示します。 +
[Replica (レプリカ)] の状況は次のとおりです。
* Started (開始済み) (緑): レプリカはトラフィックを受信中です。
* Starting (開始中): レプリカでプロセスを開始中です。
* Deleting (削除中): レプリカの削除が進行中です。
* Deleted (削除済み): レプリカは削除されました。
* Stopped (停止済み): レプリカの停止が進行中です。
* Stopped (停止済み): レプリカが停止しました (トラフィックを受信していません)。
* Failed (失敗) (赤): 設定のデプロイメントが失敗しました。 +
最後に正常にデプロイされた設定は、新しい (目的の) 設定が正常にデプロイされるまで保持されます。
+
新しい設定は「ローリング更新」として適用されます。次に例を示します。 +
* レプリカが目的の設定で作成されます。
* その設定が正常に適用されると、古い設定のレプリカは削除されます。
* このプロセスがデプロイメント内の各レプリカで繰り返されます。 +
このモデルは、更新がアプリケーションに適用されている間のダウンタイムがゼロであることを意味します。 +
[NOTE]
更新はローリング更新として適用されるため、更新が完了するまで異なるバージョンのアプリケーションが同時に実行されることになります。そのため、アプリケーションが複数のバージョンを並行して実行できることを確認してください。
+
image::app-versioning-replica-status.png[]
+
設定が正常に適用されてデプロイされると、ページの上部にメッセージが表示されます。
+
image::app-versioning-config-applied-success.png[]
+
状況ボックスのアプリケーションの状況、設定識別子、日付、その他の情報が更新されます。  *[Config changes (設定の変更)]* リストの上部に、それが最後に正常にデプロイされた設定であることを示す *[Last successful (最終成功)]* 表示ラベルと共に新しい設定が表示されます。
+
設定への更新のデプロイが失敗した場合、[`Desired configuration wasn't applied` (目的の設定は適用されませんでした)] メッセージが表示され、*[Configuration (設定)]* 状況に [`Update failed` (更新失敗)] 表示ラベルが表示されます。*[Config changes (設定の変更)]* 履歴には設定が表示ラベルなしで表示されます。
+
image::app-versioning-update-failed.png[]
+
失敗した場合、デプロイメントは最後に成功したバージョンの設定にロールバックしようとしますが、特定の状況ではロールバックが成功しないことがあります。その設定の状況は [`Update failed` (更新失敗)] と表示されます。
+
それがアプリケーションの最初のデプロイメントである場合、ロールバックバージョンは定義されず、失敗したデプロイメントは失敗状況のままになります。

== 以前に成功した設定にロールバックする

問題がある設定をデプロイした場合、以前に成功したバージョンの設定にロールバックできます。

. *[Config changes (設定の変更)]* 履歴で、ロールバックするバージョンを選択します。
. *[Deploy (デプロイ)]* をクリックします。 +
設定が *[Config changes (設定の変更)]* 履歴のリストの一番上に移動し、新しいデプロイメント日が表示されます。その元の識別ハッシュが保持されます。
